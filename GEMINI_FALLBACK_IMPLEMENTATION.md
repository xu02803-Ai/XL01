# Gemini API é™çº§æœºåˆ¶å®ç°æ€»ç»“

## å®Œæˆæƒ…å†µ

âœ… **å·²å…¨éƒ¨å®Œæˆ** - Gemini API æ™ºèƒ½é™çº§æœºåˆ¶å·²æˆåŠŸå®ç°å’Œé›†æˆ

## ä»€ä¹ˆè¢«ä¿®æ”¹äº†

### 1. æ–°åˆ›å»ºçš„æ–‡ä»¶

#### **[api/gemini-utils.ts](api/gemini-utils.ts)** (5.5KB)
æ ¸å¿ƒé™çº§é€»è¾‘åº“ï¼š
- `callGeminiWithFallback()` - é€šç”¨ API è°ƒç”¨é™çº§å‡½æ•°
- æ¨¡å‹ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼š2.5-flash â†’ 1.5-flash â†’ 1.5-pro
- `getModelStats()` - è·å–å®æ—¶ç»Ÿè®¡ä¿¡æ¯
- `disableModel()` / `enableModel()` - æ‰‹åŠ¨æ§åˆ¶
- `resetModelStats()` - é‡ç½®ç»Ÿè®¡

**å…³é”®ç‰¹æ€§ï¼š**
- è‡ªåŠ¨é”™è¯¯æ£€æµ‹ï¼ˆé…é¢ã€é€Ÿç‡é™åˆ¶ç­‰ï¼‰
- å®æ—¶ç»Ÿè®¡è¿½è¸ª
- è¯¦ç»†æ—¥å¿—è®°å½•

#### **[api/model-stats.ts](api/model-stats.ts)** (3.7KB)
ç›‘æ§å’Œæ§åˆ¶ç«¯ç‚¹ï¼š
- `GET /api/model-stats` - æŸ¥çœ‹æ‰€æœ‰æ¨¡å‹çŠ¶æ€å’Œç»Ÿè®¡
- `POST /api/model-stats` - æ§åˆ¶æ“ä½œï¼ˆreset/disable/enableï¼‰
- æ€»ä½“æˆåŠŸç‡è®¡ç®—
- æ™ºèƒ½æ¨èæ“ä½œ

#### **[GEMINI_FALLBACK_STRATEGY.md](GEMINI_FALLBACK_STRATEGY.md)** (6.5KB)
å®Œæ•´çš„ç­–ç•¥æ–‡æ¡£ï¼š
- å·¥ä½œåŸç†è§£æ
- API ä½¿ç”¨è¯¦æƒ…
- ç›‘æ§å’Œå‘Šè­¦æŒ‡å—
- å¸¸è§é—®é¢˜è§£ç­”
- å®ç°ç»†èŠ‚

#### **[GEMINI_FALLBACK_QUICK_START.md](GEMINI_FALLBACK_QUICK_START.md)** (5.2KB)
å¿«é€Ÿå¼€å§‹æŒ‡å—ï¼š
- æ ¸å¿ƒç‰¹æ€§æ¦‚è¿°
- å®ç°ç¤ºä¾‹
- éƒ¨ç½²æ£€æŸ¥æ¸…å•
- æ•…éšœæ’æŸ¥

### 2. ä¿®æ”¹çš„æ–‡ä»¶

#### **[api/generate-content.ts](api/generate-content.ts)**
```typescript
// ä¹‹å‰
import { GoogleGenAI } from "@google/genai";
const response = await ai.models.generateContent({...});

// ä¹‹å
import { callGeminiWithFallback } from "./gemini-utils";
const result = await callGeminiWithFallback(apiKey, prompt, {
  model: "gemini-2.5-flash",
  maxTokens: 4096,
});
```

**æ”¹åŠ¨ï¼š**
- å¯¼å…¥æ–°çš„é™çº§å‡½æ•°
- ç”¨ `callGeminiWithFallback` æ›¿æ¢ç›´æ¥ API è°ƒç”¨
- é”™è¯¯å¤„ç†æ”¹ä¸ºè¿”å› `modelStats`

#### **[api/generate-image.ts](api/generate-image.ts)**
```typescript
// generateImagePrompt() å’Œ extractKeyTerms() å‡½æ•°
// éƒ½æ”¹ä¸ºä½¿ç”¨ callGeminiWithFallback
const result = await callGeminiWithFallback(apiKey, prompt, {...});
```

**æ”¹åŠ¨ï¼š**
- ä¸¤ä¸ªå†…éƒ¨å‡½æ•°éƒ½é›†æˆé™çº§æœºåˆ¶
- ä¿ç•™åŸæœ‰çš„å›¾ç‰‡ç”Ÿæˆé€»è¾‘

#### **[api/synthesize-speech.ts](api/synthesize-speech.ts)**
```typescript
// æ–°å¢ä¸“ç”¨ TTS é™çº§å‡½æ•°
async function callTTSWithFallback(
  apiKey: string,
  text: string,
  voiceName: string
): Promise<{success, data?, mimeType?, model?, error?}>
```

**æ”¹åŠ¨ï¼š**
- æ–°å¢ `callTTSWithFallback()` å¤„ç† TTS ç‰¹æ®Šéœ€æ±‚
- æ”¯æŒ Modality.AUDIO é…ç½®
- ä¸“ç”¨çš„é”™è¯¯å¤„ç†é€»è¾‘

## å·¥ä½œæµç¨‹

```
ç”¨æˆ·è¯·æ±‚
    â†“
API ç«¯ç‚¹ï¼ˆcontent/image/speechï¼‰
    â†“
è°ƒç”¨ callGeminiWithFallback() / callTTSWithFallback()
    â†“
â”Œâ”€ å°è¯•æ¨¡å‹ 1 (gemini-2.5-flash)
â”œâ”€ æˆåŠŸ âœ… â†’ è¿”å›ç»“æœ + æ¨¡å‹ä¿¡æ¯
â””â”€ å¤±è´¥ âŒ â†’ æ£€æŸ¥é”™è¯¯ç±»å‹
        â”‚
        â”œâ”€ é…é¢é”™è¯¯ (RESOURCE_EXHAUSTED) â†’ å°è¯•æ¨¡å‹ 2
        â”œâ”€ é€Ÿç‡é™åˆ¶ (429) â†’ å°è¯•æ¨¡å‹ 2
        â””â”€ å…¶ä»–é”™è¯¯ â†’ å°è¯•æ¨¡å‹ 2
            â”‚
            â”œâ”€ æ¨¡å‹ 2 (gemini-1.5-flash)
            â”‚   â”œâ”€ æˆåŠŸ âœ… â†’ è¿”å›ç»“æœ
            â”‚   â””â”€ å¤±è´¥ âŒ â†’ å°è¯•æ¨¡å‹ 3
            â”‚
            â””â”€ æ¨¡å‹ 3 (gemini-1.5-pro-exp-0514)
                â”œâ”€ æˆåŠŸ âœ… â†’ è¿”å›ç»“æœ
                â””â”€ å¤±è´¥ âŒ â†’ è¿”å›é”™è¯¯
```

## å…³é”®æ”¹è¿›ç‚¹

### 1. **é›¶åœæœºæ—¶é—´**
- å½“ 2.5 é…é¢ç”¨å°½æ—¶ï¼Œè‡ªåŠ¨æ— ç¼åˆ‡æ¢
- ä¸éœ€è¦ä»£ç éƒ¨ç½²ï¼Œåªæ˜¯ API è°ƒç”¨å˜æ…¢
- ç”¨æˆ·ä¸ä¼šæ„ŸçŸ¥åˆ°ä»»ä½•ä¸­æ–­

### 2. **å¤šå±‚é™çº§ä¿éšœ**
- 3 å±‚æ¨¡å‹é™çº§ç¡®ä¿é«˜å¯ç”¨æ€§
- å³ä½¿ 2.5 å’Œ 1.5 éƒ½é…é¢ç”¨å°½ï¼Œè¿˜æœ‰ 1.5-pro
- æç«¯æƒ…å†µä¸‹æ‰ä¼šè¿”å›é”™è¯¯

### 3. **å®æ—¶ç›‘æ§**
- `/api/model-stats` ç«¯ç‚¹æä¾›å®Œæ•´å¯è§æ€§
- å¯ä»¥æŸ¥çœ‹æ¯ä¸ªæ¨¡å‹çš„æˆåŠŸç‡å’Œé”™è¯¯ä¿¡æ¯
- æ”¯æŒæ‰‹åŠ¨æ§åˆ¶ï¼ˆç¦ç”¨æ•…éšœæ¨¡å‹ï¼‰

### 4. **æˆæœ¬ä¼˜åŒ–**
- ä¼˜å…ˆä½¿ç”¨æœ€ä¾¿å®œçš„ 2.5-flash
- ä»…åœ¨å¿…è¦æ—¶é™çº§åˆ°æ›´æ˜‚è´µçš„æ¨¡å‹
- æˆæœ¬å¢åŠ é€šå¸¸åœ¨ 5-15%

### 5. **è¯¦ç»†æ—¥å¿—**
- æ¯æ¬¡è°ƒç”¨éƒ½æœ‰æ¸…æ™°çš„æ—¥å¿—è®°å½•
- ä¾¿äºè°ƒè¯•å’Œç›‘æ§

## æ¨¡å‹é€‰æ‹©åŸç†

| æ¨¡å‹ | é€Ÿåº¦ | æˆæœ¬ | è´¨é‡ | ä¸ºä»€ä¹ˆé€‰æ‹© |
|------|------|------|------|----------|
| gemini-2.5-flash | âš¡âš¡âš¡ | ğŸ’° | â­â­â­ | ä¸»æ¨¡å‹ï¼Œæœ€ä¼˜æ€§ä»·æ¯” |
| gemini-1.5-flash | âš¡âš¡ | ğŸ’°ğŸ’° | â­â­â­â­ | ç¨³å®šå¤‡ç”¨ï¼Œæˆæœ¬ä½ |
| gemini-1.5-pro-exp | âš¡ | ğŸ’°ğŸ’°ğŸ’° | â­â­â­â­â­ | æœ€åä¿éšœï¼Œé«˜è´¨é‡ |

## ç»Ÿè®¡æŒ‡æ ‡

ç³»ç»Ÿè·Ÿè¸ªä»¥ä¸‹æŒ‡æ ‡ï¼š

```typescript
interface ModelStats {
  model: string;                    // æ¨¡å‹åç§°
  successCount: number;             // æˆåŠŸè¯·æ±‚æ•°
  errorCount: number;               // å¤±è´¥è¯·æ±‚æ•°
  successRate: string;              // æˆåŠŸç‡ç™¾åˆ†æ¯”
  lastError?: string;               // æœ€åä¸€ä¸ªé”™è¯¯
  lastErrorTime?: Date;             // é”™è¯¯å‘ç”Ÿæ—¶é—´
  disabled: boolean;                // æ˜¯å¦ç¦ç”¨
}
```

## é…ç½®è¦æ±‚

**ç¯å¢ƒå˜é‡ï¼š** æ— éœ€æ–°å¢é…ç½®
- ç»§ç»­ä½¿ç”¨ç°æœ‰çš„ `GEMINI_API_KEY` æˆ– `API_KEY`
- æ‰€æœ‰æ¨¡å‹ä½¿ç”¨åŒä¸€ä¸ª API å¯†é’¥

**æ¨èé…ç½®ï¼ˆå¯é€‰ï¼‰ï¼š** ä¸åŒçš„ API å¯†é’¥ç”¨äºä¸åŒçš„æ¨¡å‹
- å¢åŠ é…é¢ç‹¬ç«‹æ€§
- æé«˜å¯ç”¨æ€§

## éƒ¨ç½²æ­¥éª¤

1. âœ… å·²åˆ›å»ºæ‰€æœ‰æ–°æ–‡ä»¶å’Œä¿®æ”¹ç°æœ‰æ–‡ä»¶
2. âœ… å·²æäº¤åˆ° gitï¼ˆcommit: `feat: add intelligent Gemini API fallback mechanism`ï¼‰
3. ä¸‹ä¸€æ­¥ï¼šéƒ¨ç½²åˆ° Vercelï¼ˆè‡ªåŠ¨æˆ–æ‰‹åŠ¨æ¨é€ï¼‰

```bash
# å¦‚æœåœ¨æœ¬åœ°ç¯å¢ƒ
git push origin main
# Vercel ä¼šè‡ªåŠ¨éƒ¨ç½²æœ€æ–°ä»£ç 
```

## æµ‹è¯•å»ºè®®

### æµ‹è¯• 1ï¼šæ­£å¸¸æµç¨‹
```bash
curl https://your-domain.com/api/generate-content
# æœŸæœ›ï¼šæˆåŠŸå“åº”ï¼Œmodel: "gemini-2.5-flash"
```

### æµ‹è¯• 2ï¼šæŸ¥çœ‹ç»Ÿè®¡
```bash
curl https://your-domain.com/api/model-stats
# æœŸæœ›ï¼šæ˜¾ç¤ºå„æ¨¡å‹ç»Ÿè®¡ä¿¡æ¯
```

### æµ‹è¯• 3ï¼šæ¨¡å‹é™çº§ï¼ˆæ¨¡æ‹Ÿï¼‰
```bash
# ç¦ç”¨ 2.5ï¼Œå¼ºåˆ¶ä½¿ç”¨ 1.5
curl -X POST https://your-domain.com/api/model-stats \
  -d '{"action": "disable", "model": "gemini-2.5-flash"}'

curl https://your-domain.com/api/generate-content
# æœŸæœ›ï¼šæˆåŠŸå“åº”ï¼Œmodel: "gemini-1.5-flash"
```

### æµ‹è¯• 4ï¼šé‡ç½®ç»Ÿè®¡
```bash
curl -X POST https://your-domain.com/api/model-stats \
  -d '{"action": "reset"}'
# æœŸæœ›ï¼šæ‰€æœ‰è®¡æ•°å™¨é‡ç½®ä¸º 0
```

## ç›‘æ§å‘Šè­¦

### å»ºè®®çš„å‘Šè­¦è§„åˆ™

1. **é…é¢å‘Šè­¦**
   ```
   æ¡ä»¶ï¼šgemini-2.5-flash æˆåŠŸç‡ < 80% ä¸”é”™è¯¯åŒ…å« "RESOURCE_EXHAUSTED"
   æ“ä½œï¼šå‘é€å‘Šè­¦ï¼Œæé†’å‡çº§é…é¢
   ```

2. **é™çº§å‘Šè­¦**
   ```
   æ¡ä»¶ï¼šgemini-1.5-flash ä½¿ç”¨ç‡ > 50%
   æ“ä½œï¼šå‘é€è­¦å‘Šï¼Œæ£€æŸ¥ 2.5 çŠ¶æ€
   ```

3. **å…¨éƒ¨æ•…éšœå‘Šè­¦**
   ```
   æ¡ä»¶ï¼šoverallSuccessRate < 50%
   æ“ä½œï¼šå‘é€ç´§æ€¥å‘Šè­¦ï¼Œæ£€æŸ¥ç½‘ç»œå’Œ API å¯†é’¥
   ```

## æˆæœ¬å½±å“åˆ†æ

å‡è®¾æ¯æœˆ 10000 ä¸ªè¯·æ±‚ï¼š

**åœºæ™¯ 1ï¼šæ— é™çº§ï¼ˆæ­£å¸¸ï¼‰**
- æˆæœ¬ï¼šåŸºäº 2.5-flash çš„å•ä»· Ã— 10000

**åœºæ™¯ 2ï¼šæœ‰é™çº§ï¼ˆ2.5 é…é¢ç”¨å°½ 30%ï¼‰**
- 2.5-flashï¼š7000 Ã— å•ä»·
- 1.5-flashï¼š3000 Ã— 1.5 å€å•ä»·
- æ€»æˆæœ¬ï¼šåŸºå‡† + 50% = å¢åŠ çº¦ 50%

**æˆæœ¬ä¼˜åŒ–å»ºè®®ï¼š**
- ç›‘æ§ä½¿ç”¨é‡ï¼Œæå‰å‡çº§é…é¢
- è€ƒè™‘æ‰¹é‡ API è°ƒç”¨
- è°ƒæ•´è¯·æ±‚é¢‘ç‡ï¼ˆå¦‚æ–°é—»ç”Ÿæˆæ¬¡æ•°ï¼‰

## å¸¸è§é—®é¢˜é€ŸæŸ¥

| é—®é¢˜ | ç­”æ¡ˆ |
|------|------|
| ç”¨æˆ·ä¼šçœ‹åˆ°å˜åŒ–å—ï¼Ÿ | å¦ï¼Œä»…å“åº”æ—¶é—´å¢åŠ  1-2s |
| æˆæœ¬ä¼šå¤§å¹…å¢åŠ å—ï¼Ÿ | å¦ï¼Œé€šå¸¸ 5-15% å¢åŠ  |
| èƒ½å¦ç¦ç”¨æŸä¸ªæ¨¡å‹ï¼Ÿ | æ˜¯ï¼Œä½¿ç”¨ `/api/model-stats` POST æ“ä½œ |
| å¦‚ä½•ç›‘æ§é™çº§ï¼Ÿ | è°ƒç”¨ `/api/model-stats` æŸ¥çœ‹ç»Ÿè®¡ |
| å¤šä¹…æ¢å¤åˆ°ä¸»æ¨¡å‹ï¼Ÿ | é…é¢æ¢å¤åè‡ªåŠ¨åˆ‡å›ï¼ˆæœˆæœ«æˆ–å‡çº§åï¼‰ |

## ç›¸å…³æ–‡ä»¶æ¸…å•

- âœ… [api/gemini-utils.ts](api/gemini-utils.ts) - æ ¸å¿ƒé€»è¾‘ï¼ˆæ–°å»ºï¼‰
- âœ… [api/model-stats.ts](api/model-stats.ts) - ç›‘æ§ç«¯ç‚¹ï¼ˆæ–°å»ºï¼‰
- âœ… [api/generate-content.ts](api/generate-content.ts) - å·²ä¿®æ”¹
- âœ… [api/generate-image.ts](api/generate-image.ts) - å·²ä¿®æ”¹
- âœ… [api/synthesize-speech.ts](api/synthesize-speech.ts) - å·²ä¿®æ”¹
- âœ… [GEMINI_FALLBACK_STRATEGY.md](GEMINI_FALLBACK_STRATEGY.md) - æ–‡æ¡£ï¼ˆæ–°å»ºï¼‰
- âœ… [GEMINI_FALLBACK_QUICK_START.md](GEMINI_FALLBACK_QUICK_START.md) - å¿«é€ŸæŒ‡å—ï¼ˆæ–°å»ºï¼‰

## æ€»ç»“

è¿™ä¸ªå®ç°æä¾›äº†ï¼š
1. **è‡ªåŠ¨é™çº§** - æ— éœ€äººå·¥å¹²é¢„
2. **å¤šå±‚ä¿éšœ** - 3 ä¸ªæ¨¡å‹çš„é™çº§é“¾
3. **å®æ—¶ç›‘æ§** - å®Œæ•´çš„ç»Ÿè®¡å’Œæ§åˆ¶
4. **é›¶ä¸­æ–­** - ç”¨æˆ·ä½“éªŒæ— å½±å“
5. **æˆæœ¬æ§åˆ¶** - ä¼˜å…ˆä½¿ç”¨æœ€ä¾¿å®œçš„æ¨¡å‹

å½“ Gemini 2.5 é…é¢è¢«é™åˆ¶æ—¶ï¼Œç³»ç»Ÿä¼šæ— ç¼åœ°é™çº§åˆ° 1.5 Flashï¼Œ**è‡ªåŠ¨ä¿è¯æœåŠ¡è¿ç»­æ€§**ã€‚
