export const generateNewsImage = async (headline: string, summary?: string, category?: string): Promise<string | null> => {
  try {
    console.log("ğŸ–¼ï¸ Requesting image for:", headline.substring(0, 50));
    const token = getAuthToken();
    const controller = new AbortController();
    // å¢åŠ è¶…æ—¶æ—¶é—´ï¼Œç»™äºˆå¤šä¸ªå›¾ç‰‡æºå°è¯•çš„æ—¶é—´
    const timeoutId = setTimeout(() => controller.abort(), 20000);
    
    // ä¼ é€’æ›´å¤šå‚æ•°ç»™åç«¯ï¼Œä¾¿äºç”Ÿæˆæ›´å¥½çš„å›¾ç‰‡
    const params = new URLSearchParams({
      action: 'image',
      headline: headline,
      ...(summary ? { summary } : {}),
      ...(category ? { category } : {}),
      timestamp: Date.now().toString()
    });
    
    const url = `/api/ai-handler?${params.toString()}`;
    
    const response = await fetch(url, {
      method: 'GET',
      signal: controller.signal,
      headers: token ? {
        'Authorization': `Bearer ${token}`,
      } : {},
    });

    clearTimeout(timeoutId);

    if (!response.ok) {
      console.warn("âš ï¸ Image API error:", response.status);
      // è¿”å›å¤‡ç”¨å›¾ç‰‡è€Œä¸æ˜¯null
      return generatePlaceholderUrl(category || 'Tech');
    }

    const data = await response.json();
    
    // æ–°APIæ”¯æŒsuccess:falseä½†ä»è¿”å›å¤‡ç”¨å›¾ç‰‡
    if (data.imageUrl) {
      console.log("âœ… Image URL received:", data.source || 'unknown source');
      return data.imageUrl;
    }

    // å¤‡ç”¨ï¼šå¤„ç† base64 å“åº”
    if (data.data && data.mimeType) {
      console.log("âœ… Image received as base64");
      return `data:${data.mimeType};base64,${data.data}`;
    }

    // å¦‚æœæ²¡æœ‰imageUrlä½†æˆåŠŸï¼Œè¿”å›å¤‡ç”¨
    if (data.success === true) {
      console.log("âš ï¸ Response succeeded but no image data, using placeholder");
      return generatePlaceholderUrl(category || 'Tech');
    }

    console.warn("Image generation failed:", data.error);
    return generatePlaceholderUrl(category || 'Tech');
    
  } catch (e: any) {
    if (e.name === 'AbortError') {
      console.warn("â±ï¸ Image generation timeout for:", headline);
    } else {
      console.warn("âŒ Image gen exception:", headline, e.message);
    }
    // è¿”å›å¤‡ç”¨å›¾ç‰‡è€Œä¸æ˜¯null
    return generatePlaceholderUrl(category || 'Tech');
  }
};

/**
 * ç”Ÿæˆæœ¬åœ°å ä½å›¾URL - ç§‘æŠ€ç›¸å…³çš„æ¸å˜è‰²
 */
const generatePlaceholderUrl = (category: string): string => {
  const colors: Record<string, [string, string]> = {
    'AI': ['4F46E5', '3B82F6'],  // è“è‰²ç³» - AI
    'Tech': ['6366F1', '8B5CF6'],  // ç´«è“è‰² - æŠ€æœ¯
    'Semiconductors': ['F97316', 'EF4444'],  // æ©™çº¢è‰² - èŠ¯ç‰‡
    'Energy': ['16A34A', '22C55E'],  // ç»¿è‰² - èƒ½æº
    'Science': ['0891B2', '06B6D4'],  // é’è‰² - ç§‘å­¦
    'default': ['475569', '64748B']  // ç°è‰² - é»˜è®¤
  };
  
  const [color1, color2] = colors[category] || colors['default'];
  
  // ç”ŸæˆSVGæ ‡è®°çš„base64å ä½å›¾
  const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="1024" height="576" viewBox="0 0 1024 576">
    <defs>
      <linearGradient id="grad-${category}" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" style="stop-color:#${color1};stop-opacity:1"/>
        <stop offset="100%" style="stop-color:#${color2};stop-opacity:1"/>
      </linearGradient>
    </defs>
    <rect width="1024" height="576" fill="url(#grad-${category})"/>
    <g opacity="0.3">
      <circle cx="200" cy="150" r="80" fill="white"/>
      <circle cx="800" cy="400" r="120" fill="white"/>
      <path d="M 100 500 Q 300 300 500 400 T 900 350" stroke="white" stroke-width="3" fill="none"/>
    </g>
    <text x="512" y="250" font-size="64" font-weight="bold" fill="white" text-anchor="middle" font-family="Arial, sans-serif" opacity="0.9">ğŸš€</text>
    <text x="512" y="340" font-size="32" fill="white" text-anchor="middle" font-family="Arial, sans-serif" opacity="0.7">ç§‘æŠ€å‰æ²¿</text>
  </svg>`;
  
  const base64 = Buffer.from(svg).toString('base64');
  return `data:image/svg+xml;base64,${base64}`;
};
